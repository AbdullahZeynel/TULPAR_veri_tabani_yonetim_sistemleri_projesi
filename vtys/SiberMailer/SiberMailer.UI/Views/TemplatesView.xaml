<UserControl x:Class="SiberMailer.UI.Views.TemplatesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SiberMailer.UI.ViewModels"
             xmlns:local="clr-namespace:SiberMailer.UI.Views"
             Background="{DynamicResource WindowBackgroundBrush}">

    <UserControl.DataContext>
        <vm:TemplatesViewModel/>
    </UserControl.DataContext>

    <Grid>
        <!-- Main Content Grid: 2 Columns -->
        <Grid Margin="10,10,10,50">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1.2*"/>
                <!-- Left Panel: DataGrid & Filters -->
                <ColumnDefinition Width="1.8*"/>
                <!-- Right Panel: Preview & Actions -->
            </Grid.ColumnDefinitions>

            <!-- ================================ -->
            <!-- LEFT PANEL: DataGrid & Filters -->
            <!-- ================================ -->
            <Border Grid.Column="0" 
                    Background="{DynamicResource CardBackgroundBrush}"
                    CornerRadius="12"
                    Margin="0,0,10,0"
                    Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Filters -->
                        <RowDefinition Height="*"/>
                        <!-- DataGrid -->
                        <RowDefinition Height="Auto"/>
                        <!-- Add Button -->
                    </Grid.RowDefinitions>

                    <!-- Filters Section -->
                    <StackPanel Grid.Row="0" Margin="0,0,0,15">
                        <!-- Search Bar with Icon Button -->
                        <TextBlock Text="Search"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   FontSize="11"
                                   Margin="0,0,0,5"/>
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{DynamicResource ModernTextBoxStyle}"/>
                            <Button Grid.Column="1"
                                    Command="{Binding SearchCommand}"
                                    Style="{DynamicResource ModernButtonStyle}" Height="38"
                                    Margin="8,1,-6,0"
                                    ToolTip="Search">
                                <TextBlock Text="ðŸ”" FontSize="16" Width="22" Height="21"/>
                            </Button>
                        </Grid>

                        <!-- Filters Row -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Branch Filter -->
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Branch"
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11"
                                           Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding BranchFilterList}"
                                          SelectedItem="{Binding SelectedBranchFilter}"
                                          DisplayMemberPath="BranchName"
                                          Style="{DynamicResource ModernComboBoxStyle}"/>
                            </StackPanel>

                            <!-- Status Filter -->
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Status"
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11"
                                           Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding StatusFilterList}"
                                          SelectedItem="{Binding SelectedStatusFilter}"
                                          Style="{DynamicResource ModernComboBoxStyle}"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>

                    <!-- Templates DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding FilteredTemplates}"
                              SelectedItem="{Binding SelectedTemplate}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              SelectionUnit="FullRow"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              CanUserReorderColumns="False"
                              HeadersVisibility="Column"
                              GridLinesVisibility="None"
                              BorderThickness="0"
                              Background="Transparent"
                              RowBackground="{DynamicResource PanelBackgroundBrush}"
                              AlternatingRowBackground="{DynamicResource CardBackgroundBrush}"
                              Foreground="{DynamicResource PrimaryTextBrush}"
                              RowHeight="50"
                              ColumnHeaderHeight="40">

                        <!-- DataGrid Style -->
                        <DataGrid.Resources>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="{DynamicResource PanelBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource SecondaryTextBrush}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="FontSize" Value="12"/>
                                <Setter Property="Padding" Value="10,8"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Margin" Value="0,2"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                            <Style TargetType="DataGridCell">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Padding" Value="10,5"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Background="{TemplateBinding Background}" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Resources>

                        <DataGrid.Columns>
                            <!-- Template Name Column -->
                            <DataGridTemplateColumn Header="Template Name" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel VerticalAlignment="Center">
                                            <TextBlock Text="{Binding TemplateName}"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding BranchName}"
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       FontSize="11"
                                                       Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- Status Column -->
                            <DataGridTemplateColumn Header="Status" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="10"
                                                Padding="8,4"
                                                HorizontalAlignment="Center">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#30E85050"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsActive}" Value="True">
                                                            <Setter Property="Background" Value="#306FCF7C"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock FontSize="10" FontWeight="SemiBold" HorizontalAlignment="Center">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text" Value="OFF"/>
                                                        <Setter Property="Foreground" Value="#E85050"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsActive}" Value="True">
                                                                <Setter Property="Text" Value="ON"/>
                                                                <Setter Property="Foreground" Value="#6FCF7C"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- Actions Column (Edit & Delete) -->
                            <DataGridTemplateColumn Header="Actions" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <!-- Edit Button -->
                                            <Button Command="{Binding DataContext.EditRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Edit Template"
                                                    Width="32" Height="32"
                                                    Margin="0,0,5,0"
                                                    Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderThickness" Value="0"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border"
                                                                            Background="{TemplateBinding Background}"
                                                                            CornerRadius="6"
                                                                            Padding="5">
                                                                        <TextBlock Text="âœï¸" FontSize="14" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- Delete Button -->
                                            <Button Command="{Binding DataContext.DeleteRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Delete Template"
                                                    Width="32" Height="32"
                                                    Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderThickness" Value="0"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border"
                                                                            Background="{TemplateBinding Background}"
                                                                            CornerRadius="6"
                                                                            Padding="5">
                                                                        <TextBlock Text="ðŸ—‘ï¸" FontSize="14" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#30E85050"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Add Template Button -->
                    <Button Grid.Row="2"
                            Command="{Binding AddTemplateCommand}"
                            Style="{DynamicResource AccentButtonStyle}"
                            Margin="0,0,0,15"
                            Height="45">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="âž•" Margin="0,0,10,0" FontSize="14"/>
                            <TextBlock Text="Add New Template" FontSize="13" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <!-- ================================ -->
            <!-- RIGHT PANEL: Preview & Actions -->
            <!-- ================================ -->
            <Border Grid.Column="1"
                    Background="{DynamicResource CardBackgroundBrush}"
                    CornerRadius="12"
                    Padding="20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Header -->
                        <RowDefinition Height="*"/>
                        <!-- Preview -->
                        <RowDefinition Height="Auto"/>
                        <!-- Actions -->
                    </Grid.RowDefinitions>

                    <!-- Template Header -->
                    <StackPanel Grid.Row="0" Margin="0,0,0,15"
                                Visibility="{Binding HasSelectedTemplate, Converter={StaticResource BoolToVisibility}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0"
                                       Text="{Binding SelectedTemplate.TemplateName}"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       FontSize="20"
                                       FontWeight="Bold"
                                       TextTrimming="CharacterEllipsis"/>

                            <!-- Status Badge -->
                            <Border Grid.Column="1"
                                    CornerRadius="12"
                                    Padding="12,6">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#30E85050"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedTemplate.IsActive}" Value="True">
                                                <Setter Property="Background" Value="#306FCF7C"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding SelectedTemplateStatusText}"
                                           FontWeight="SemiBold"
                                           FontSize="12">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="#E85050"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedTemplate.IsActive}" Value="True">
                                                    <Setter Property="Foreground" Value="#6FCF7C"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Border>
                        </Grid>
                        <TextBlock Text="{Binding SelectedTemplate.BranchName}"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   FontSize="12"
                                   Margin="0,5,0,0"/>
                    </StackPanel>

                    <!-- HTML Preview (Source View) -->
                    <Border Grid.Row="1"
                            Background="{DynamicResource PanelBackgroundBrush}"
                            CornerRadius="8"
                            Margin="0,0,0,15">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto"
                                      Visibility="{Binding HasSelectedTemplate, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="{Binding SelectedTemplate.HtmlContent}"
                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                       FontFamily="Consolas"
                                       FontSize="11"
                                       TextWrapping="Wrap"
                                       Padding="10"/>
                        </ScrollViewer>
                    </Border>

                    <!-- Placeholder when no template selected -->
                    <StackPanel Grid.Row="1"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                Visibility="{Binding HasSelectedTemplate, Converter={StaticResource InverseBoolToVisibility}}">
                        <TextBlock Text="ðŸ“"
                                   FontSize="64"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,20"/>
                        <TextBlock Text="Select a template to preview"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   FontSize="16"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>

                    <!-- Action Buttons -->
                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Visibility="{Binding HasSelectedTemplate, Converter={StaticResource BoolToVisibility}}">

                        <!-- Toggle Status Button -->
                        <Button Command="{Binding ToggleStatusCommand}"
                                Style="{DynamicResource ModernButtonStyle}"
                                Padding="15,10"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Margin="0,0,8,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="âœ“"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedTemplate.IsActive}" Value="True">
                                                    <Setter Property="Text" Value="âœ—"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock>
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="Enable"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedTemplate.IsActive}" Value="True">
                                                    <Setter Property="Text" Value="Disable"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- ================================ -->
        <!-- ADD/EDIT TEMPLATE DIALOG OVERLAY -->
        <!-- ================================ -->
        <Grid Visibility="{Binding ShowTemplateDialog, Converter={StaticResource BoolToVisibility}}">
            <!-- Dark Overlay -->
            <Border Background="#80000000"/>

            <!-- Dialog Box -->
            <Border Background="{DynamicResource CardBackgroundBrush}"
                    CornerRadius="16"
                    Padding="30"
                    Width="500"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <StackPanel>
                    <!-- Dialog Header -->
                    <TextBlock Text="{Binding DialogTitle}"
                               Foreground="{DynamicResource PrimaryTextBrush}"
                               FontSize="22"
                               FontWeight="Bold"
                               Margin="0,0,0,20"/>

                    <!-- Template Name -->
                    <TextBlock Text="Template Name"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               FontSize="12"
                               Margin="0,0,0,5"/>
                    <TextBox Text="{Binding DialogTemplateName, UpdateSourceTrigger=PropertyChanged}"
                             Style="{DynamicResource ModernTextBoxStyle}"
                             Margin="0,0,0,15"/>

                    <!-- Branch Selection -->
                    <TextBlock Text="Branch"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               FontSize="12"
                               Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding BranchFilterList}"
                              SelectedItem="{Binding DialogTemplateBranch}"
                              DisplayMemberPath="BranchName"
                              Style="{DynamicResource ModernComboBoxStyle}"
                              Margin="0,0,0,15"/>

                    <!-- Import HTML Button -->
                    <Button Command="{Binding LoadHtmlFromFileCommand}"
                            Style="{DynamicResource ModernButtonStyle}"
                            Height="45"
                            Margin="0,0,0,15">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“„" Margin="0,0,10,0" FontSize="16"/>
                            <TextBlock Text="Import HTML File" FontSize="13"/>
                        </StackPanel>
                    </Button>

                    <!-- HTML Content Preview -->
                    <TextBlock Text="HTML Content (Read-Only Preview)"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               FontSize="12"
                               Margin="0,0,0,5"/>
                    <Border Background="{DynamicResource PanelBackgroundBrush}"
                            CornerRadius="8"
                            Padding="10"
                            Height="120"
                            Margin="0,0,0,20">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                            <TextBlock Text="{Binding DialogTemplateHtmlContent}"
                                     Foreground="{DynamicResource SecondaryTextBrush}"
                                     FontFamily="Consolas"
                                     FontSize="10"
                                     TextWrapping="Wrap"/>
                        </ScrollViewer>
                    </Border>

                    <!-- Dialog Buttons -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="1"
                                Command="{Binding CancelDialogCommand}"
                                Content="Cancel"
                                Style="{DynamicResource ModernButtonStyle}"
                                Padding="20,10"
                                Margin="0,0,10,0"/>

                        <Button Grid.Column="2"
                                Command="{Binding SaveTemplateCommand}"
                                Content="{Binding SaveButtonText}"
                                Style="{DynamicResource AccentButtonStyle}"
                                Padding="20,10"/>
                    </Grid>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border VerticalAlignment="Bottom"
                Background="{DynamicResource PanelBackgroundBrush}"
                Padding="15,8"
                Margin="10"
                CornerRadius="8">
            <TextBlock Text="{Binding StatusMessage}"
                       Foreground="{DynamicResource SecondaryTextBrush}"
                       FontSize="12" Margin="-5,0,5,0" Height="46"/>
        </Border>
    </Grid>
</UserControl>
